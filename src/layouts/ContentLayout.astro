---
import { Image, getImage } from "astro:assets";
import Layout from "./Layout.astro";
import Copyright from "../components/Copyright.astro";
const { frontmatter } = Astro.props;
const assets = import.meta.glob<{ default: ImageMetadata }>("../assets/**/*");

const imgAsset = await assets[frontmatter.img]();
const optimizedImage = await getImage({
  src: imgAsset.default,
  quality: 85,
  format: "webp",
});

const subImagesAssets =
  frontmatter.subImages && frontmatter.subImages.length > 0
    ? await Promise.all(
        frontmatter.subImages.map((subImage: string) => {
          return assets[subImage]();
        }),
      )
    : [];
const pageTitle = `${frontmatter.title} | YAAD.inc`;

// すべてのページデータを取得して、現在のページのインデックスを計算
const allPagesModules = import.meta.glob("../pages/*.md", { eager: true });
const allPages = Object.values(allPagesModules);
const allContents = allPages.map(({ frontmatter }: any) => frontmatter);

const currentPageIndex = allContents.findIndex(
  (content) => content.id === frontmatter.id,
);
---

<Layout title={pageTitle} ogType="article">
  <main
    class="pt-[16.8rem] px-[1.8rem] relative md:pt-[16.8rem] md:px-[2.4rem]"
    data-page-index={currentPageIndex}
  >
    <div class="flex flex-col gap-[7rem] md:gap-[12.5rem]">
      <div class="flex flex-col gap-[1.6rem]">
        <h1
          class="text-white font-neue text-[4rem] font-semibold leading-[100%] md:text-[9.6rem]"
        >
          {frontmatter.title}
        </h1>
        <div
          class="font-neue font-normal grid grid-cols-[6rem_1fr] md:grid-cols-[8rem_1fr] gap-x-[5.2rem] gap-y-[1.2rem] h-fit md:row-[1/2] md:sticky md:top-[16.8rem] text-[1.1rem] md:text-[1.4rem]"
        >
          {
            frontmatter.client && (
              <>
                <h5>Client</h5>
                <p>{frontmatter.client}</p>
              </>
            )
          }
          {
            frontmatter.release && (
              <>
                <h5>Release</h5>
                <p>{frontmatter.release}</p>
              </>
            )
          }
          {
            frontmatter.categories && (
              <>
                <h5>Categories</h5>
                <p>{frontmatter.categories?.join(", ")}</p>
              </>
            )
          }
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-[47.5rem_1fr]">
        <a
          class="hidden md:block md:sticky md:top-[20rem] md:self-start w-fit text-white font-neue text-[2.8rem] font-semibold leading-[100%] underline"
          href="/">Back To Page</a
        >
        <div class="flex flex-col gap-[7rem] md:gap-[10rem]">
          <div class="flex flex-col gap-[4rem] md:gap-[7rem]">
            <Image
              class="w-full h-auto"
              src={imgAsset.default}
              alt="main-image"
              quality={85}
              format="webp"
            />
            {
              subImagesAssets &&
                subImagesAssets.length > 0 &&
                subImagesAssets.map((subImageAsset, index) => {
                  return (
                    <Image
                      class="w-full h-auto"
                      src={subImageAsset.default}
                      alt={`sub-image-${index + 1}`}
                      quality={85}
                      format="webp"
                    />
                  );
                })
            }
            <article>
              <slot />
            </article>
          </div>
          <div
            class="flex flex-col gap-[6rem] pt-[2.4rem] md:pt-[4rem] border-t border-white/30"
          >
            <div
              class="grid grid-cols-1 md:grid-cols-[1fr_1fr] gap-[2.4rem] md:gap-[1.2rem] text-[1.1rem] md:text-[1.4rem]"
            >
              <div
                class="font-neue font-normal grid grid-cols-[6rem_1fr] md:grid-cols-[12rem_1fr] gap-x-[5.2rem] gap-y-[1.2rem] h-fit md:row-[1/2] md:sticky md:top-[16.8rem]"
              >
                {
                  frontmatter.client && (
                    <>
                      <h5 class="font-semibold">Client</h5>
                      <p>{frontmatter.client}</p>
                    </>
                  )
                }
                {
                  frontmatter.release && (
                    <>
                      <h5 class="font-semibold">Release</h5>
                      <p>{frontmatter.release}</p>
                    </>
                  )
                }
                {
                  frontmatter.categories && (
                    <>
                      <h5 class="font-semibold mb-8 md:mb-[7.2rem]">
                        Categories
                      </h5>
                      <p>{frontmatter.categories?.join(", ")}</p>
                    </>
                  )
                }
              </div>
              <div
                class="font-neue font-normal grid grid-cols-[6rem_1fr] md:grid-cols-[12rem_1fr] gap-x-[5.2rem] gap-y-[1.2rem] h-fit md:row-[1/2] md:sticky md:top-[16.8rem]"
              >
                <h5 class="font-semibold">Credit</h5>
                <div class="flex flex-col gap-[1.6rem] md:gap-[2.8rem]">
                  {
                    frontmatter.client && (
                      <div class="flex flex-col gap-[0.6rem] md:gap-[0.8rem]">
                        <p>Client</p>
                        <p>{frontmatter.client}</p>
                      </div>
                    )
                  }
                  {
                    frontmatter.credits &&
                      frontmatter.credits?.map(({ name, value }: any) => {
                        return (
                          <div class="flex flex-col gap-[0.6rem] md:gap-[0.8rem]">
                            <p>{name}</p>
                            <p>{value}</p>
                          </div>
                        );
                      })
                  }
                </div>
              </div>
            </div>
            <a
              class="block md:hidden w-fit text-white font-neue text-[2.8rem] font-semibold leading-[100%] underline"
              href="/">Back To Page</a
            >
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer
    class="mt-[5.6rem] text-right md:mt-56 px-[1.8rem] pb-[2.4rem] md:px-[2.4rem] md:pb-8"
  >
    <Copyright />
  </footer>
  <div
    class="fixed top-0 left-0 w-full h-full object-cover z-[-1] blur-[10px] overflow-hidden scale-110"
    style={`opacity: 1; background-image: url(${optimizedImage.src}); background-size: cover; background-position: center;`}
  >
    <div class="absolute inset-0 bg-black/20"></div>
  </div>
  <script>
    import { activeIndex } from "../lib/store";

    // 個別ページにアクセスしたときに、activeIndexを設定してヘッダーに正しい値を表示
    document.addEventListener("DOMContentLoaded", function () {
      const mainElement = document.querySelector(
        "main[data-page-index]",
      ) as HTMLElement;
      if (mainElement) {
        const pageIndex = parseInt(
          mainElement.getAttribute("data-page-index") || "-1",
        );
        if (pageIndex >= 0) {
          activeIndex.set(pageIndex);
        }
      }

      const backToPageLink = document.querySelector(
        "a[data-section-index]",
      ) as HTMLAnchorElement;
      if (backToPageLink) {
        backToPageLink.addEventListener("click", function () {
          const sectionIndex = this.getAttribute("data-section-index");
          if (sectionIndex !== null) {
            sessionStorage.setItem("scrollToSection", sectionIndex);
          }
        });
      }
    });
  </script>
</Layout>
