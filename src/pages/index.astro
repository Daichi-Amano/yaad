---
import Layout from "../layouts/Layout.astro";
import Copyright from "../components/Copyright.astro";
import MainContent from "../components/MainContent.astro";
import Loading from "../components/Loading.astro";
const dataModules = import.meta.glob("./*.md", { eager: true });
const data = Object.values(dataModules);
console.log(data);
const contents = data.map(({ url, frontmatter }: any) => {
  return {
    id: url.replace("/", ""),
    ...frontmatter,
  };
});
contents.sort((a, b) => {
  const dateA = new Date(a.release ?? 0);
  const dateB = new Date(b.release ?? 0);
  return dateB.getTime() - dateA.getTime();
});
---

<Layout
  title="YAAD.inc"
  description="YAAD.inc - Creative Studio. クリエイティブスタジオとして、ブランディング、デザイン、映像制作など様々な領域で活動しています。"
>
  <Loading />
  <main class="py-16 max-w-full flex-1">
    {
      contents.map(({ id, title, categories, release, img }, index) => {
        return (
          <MainContent
            id={id}
            index={index}
            title={title}
            categories={categories}
            release={release}
            img={img}
          />
        );
      })
    }
  </main>
  <footer
    class="fixed bottom-0 left-0 w-full flex justify-between px-[1.8rem] pb-[2.4rem] md:px-[2.4rem] md:pb-8"
  >
    <div class="bg-white/50 w-[0.2rem] h-[1.8rem] relative">
      <span
        class="absolute top-0 left-0 w-full h-[0.4rem] bg-white animate-[scroll_2s_linear_infinite]"
      ></span>
    </div>
    <Copyright />
  </footer>
  <script>
    // 戻る・進むボタンでの遷移を検出するフラグ
    let isPopStateNavigation = false;

    // 戻る・進むボタンでの遷移を検出
    window.addEventListener("popstate", () => {
      isPopStateNavigation = true;
      // フラグを一定時間後にリセット（次の通常遷移のため）
      setTimeout(() => {
        isPopStateNavigation = false;
      }, 1000);
    });

    // ページ遷移前にスクロール位置を保存
    document.addEventListener("astro:before-swap", () => {
      if (window.location.pathname !== "/") return;
      // 戻る・進むボタンでの遷移の場合は保存をスキップ
      if (isPopStateNavigation) {
        return;
      }
      const scrollY = window.scrollY;
      sessionStorage.setItem("scrollPosition", scrollY.toString());
    });

    // スクロール位置を復元する関数
    function restoreScrollPosition() {
      if (window.location.pathname !== "/") return;
      // 戻る・進むボタンでの遷移の場合は復元をスキップ
      if (isPopStateNavigation) {
        // 保存されたスクロール位置をクリア（戻る・進むボタンでは不要）
        sessionStorage.removeItem("scrollPosition");
        return;
      }
      const savedScrollPosition = sessionStorage.getItem("scrollPosition");
      if (savedScrollPosition !== null) {
        // View Transitionsのアニメーション完了後にスクロール
        // 少し遅延を入れて、DOMが完全にレンダリングされるのを待つ
        setTimeout(() => {
          window.scrollTo({
            top: parseInt(savedScrollPosition, 10),
            behavior: "auto", // スムーズスクロールではなく即座に移動
          });
          // sessionStorageをクリア（一度だけ復元）
          sessionStorage.removeItem("scrollPosition");
        }, 0);
      }
    }

    // 初回読み込み時（通常のページ読み込み）
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", restoreScrollPosition);
    } else {
      restoreScrollPosition();
    }

    // View Transitionsのページ遷移後にも実行
    document.addEventListener("astro:page-load", () => {
      // 少し遅延を入れて、View Transitionsのアニメーションが完了するのを待つ
      setTimeout(restoreScrollPosition, 100);
    });
    document.addEventListener("astro:after-swap", () => {
      setTimeout(restoreScrollPosition, 100);
    });
  </script>
</Layout>
