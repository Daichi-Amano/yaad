name: Deploy to Vercel

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Hobbyプランでは、第三者のコミットでもデプロイをトリガーするために必要
    steps:
      - name: Trigger Vercel Deployment
        run: |
          if [ -z "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" ]; then
            echo "⚠️ VERCEL_DEPLOY_HOOK_URL が設定されていません。"
            echo "GitHubリポジトリの Settings → Secrets and variables → Actions で設定してください。"
            exit 1
          fi

          echo "🚀 Vercelへのデプロイをトリガーしています..."
          echo "Deploy Hook URL: ${VERCEL_DEPLOY_HOOK_URL:0:50}..." # 最初の50文字のみ表示（セキュリティのため）

          # レスポンスを変数に保存
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}")

          # HTTPステータスコードを抽出
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "📋 レスポンス:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "✅ デプロイがトリガーされました (HTTP $HTTP_STATUS)"
            echo ""
            echo "📝 次のステップ:"
            echo "   Vercelダッシュボードでデプロイメントの状態を確認してください:"
            echo "   https://vercel.com/dashboard"
          else
            echo "❌ デプロイのトリガーに失敗しました (HTTP $HTTP_STATUS)"
            echo "📋 エラーレスポンス:"
            echo "$BODY"
            exit 1
          fi
