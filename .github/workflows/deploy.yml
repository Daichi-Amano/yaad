name: Deploy to Vercel

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Hobbyãƒ—ãƒ©ãƒ³ã§ã¯ã€ç¬¬ä¸‰è€…ã®ã‚³ãƒŸãƒƒãƒˆã§ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã«å¿…è¦
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Vercel using Deploy Hook
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$VERCEL_DEPLOY_HOOK_URL" ]; then
            echo "âŒ VERCEL_DEPLOY_HOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            echo ""
            echo "Deploy Hook ã®ä½œæˆæ–¹æ³•:"
            echo "1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ Git â†’ Deploy Hooks"
            echo "2. æ–°ã—ã„Hookã‚’ä½œæˆ"
            echo "   - Name: GitHub Actions Deploy"
            echo "   - Branch: master (ã¾ãŸã¯ãƒ–ãƒ©ãƒ³ãƒåã‚’ä¸€è‡´ã•ã›ã‚‹)"
            echo "   - Git Provider: GitHub"
            echo "3. ç”Ÿæˆã•ã‚ŒãŸURLã‚’ VERCEL_DEPLOY_HOOK_URL ã¨ã—ã¦GitHub Secretsã«è¨­å®š"
            exit 1
          fi

          echo "ğŸš€ Vercelã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™..."
          echo "ğŸ“ ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ“ ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"

          # Deploy Hookã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Git authorã®ãƒã‚§ãƒƒã‚¯ã‚’å›é¿ã§ãã¾ã™
          # ã“ã‚Œã«ã‚ˆã‚Šã€åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®pushã§ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«ãªã‚Šã¾ã™
          response=$(curl -s -w "\n%{http_code}" -X POST "$VERCEL_DEPLOY_HOOK_URL")

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            echo "âœ… Deploy HookãŒæ­£å¸¸ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã—ãŸ (HTTP $http_code)"
            echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $body"
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
            if echo "$body" | grep -q '"url"'; then
              deployment_url=$(echo "$body" | grep -o '"url":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "ğŸ”— ãƒ‡ãƒ—ãƒ­ã‚¤URL: $deployment_url"
            fi
            
            if echo "$body" | grep -q '"id"'; then
              job_id=$(echo "$body" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "ğŸ“‹ Job ID: $job_id"
            fi
            
            echo ""
            echo "â„¹ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚"
            echo "   ãƒ‡ãƒ—ãƒ­ã‚¤ã®çŠ¶æ…‹ã¯Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèªã—ã¦ãã ã•ã„:"
            echo "   https://vercel.com/dashboard"
          else
            echo "âŒ Deploy Hookã®ãƒˆãƒªã‚¬ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $http_code)"
            echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $body"
            exit 1
          fi
