---
import { Image, getImage } from "astro:assets";
const { id, img, title, categories, release } = Astro.props;
const assets = import.meta.glob<{ default: ImageMetadata }>("../assets/**/*");
const imgAsset = await assets[`../assets/images/${img}`]();
const optimizedImage = await getImage({ src: imgAsset.default });
---

<div id={id} data-section class="relative h-screen w-full flex items-center">
  <div
    class="fixed top-0 left-0 w-full h-full object-cover opacity-0 z-[-1] transition-opacity duration-1000 blur-[10px] overflow-hidden scale-110"
    style={`background-image: url(${optimizedImage.src}); background-size: 120%; background-position: center;`}
    data-background-image
  >
    <div class="absolute inset-0 bg-black/20"></div>
  </div>
  <a href={`/${id}`} class="overflow-x-clip w-full">
    <div class="flex shrink-0 overflow-hidden">
      <div class="flex shrink-0 animate-[ticker_30s_-15s_linear_infinite]">
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
      </div>
      <div class="flex shrink-0 animate-[ticker2_30s_linear_infinite]">
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
        <Image
          class="shrink-0 h-136 w-136 px-[0.7rem] md:px-[0.85rem] md:h-[51.7rem] md:w-[51.7rem]"
          src={imgAsset.default}
          alt="main-image"
        />
      </div>
    </div>
    <div
      class="text-white font-neue font-semibold capitalize px-[1.8rem] md:px-0 flex flex-col gap-[0.6rem] -mt-[2.2rem] relative z-10 md:gap-[0.7rem] md:-mt-[9.8rem] md:ml-56"
    >
      <h1 class="text-[4rem] leading-[100%] md:text-[9.6rem]">{title}</h1>
      <div class="flex flex-col gap-[1.4rem] md:gap-[1.6rem]">
        <p class="text-[1.3rem] leading-[100%] md:text-[1.8rem]">
          Release - {release}
        </p>
        <div class="flex flex-wrap gap-[0.7rem] md:gap-[1rem]">
          {
            categories?.map((category) => {
              return (
                <span class="inline-block text-[1.2rem] py-[0.7rem] px-[1rem] font-abril border border-white text-[1.3rem] leading-[100%] md:text-[1.8rem] font-medium px-3 py-1 rounded-full">
                  {category.toUpperCase()}
                </span>
              );
            })
          }
        </div>
      </div>
    </div>
  </a>
</div>
<script>
  import { activeIndex } from "../lib/store";

  function initBackgroundAnimations() {
    // セクションのみを対象にして、ローディングなど別要素のIDを除外
    const targets = document.querySelectorAll("[data-section]");
    let currentActiveIndex = -1;

    targets.forEach(function (target, index) {
      const backgroundImage = target.querySelector(
        "[data-background-image]",
      ) as HTMLElement;

      // 既存のオブザーバーをクリーンアップ
      const existingObserver = (target as any).__intersectionObserver;
      if (existingObserver) {
        existingObserver.disconnect();
      }

      var observer = new IntersectionObserver(
        function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              // 前の背景をフェードアウト
              if (currentActiveIndex >= 0 && currentActiveIndex !== index) {
                const prevTarget = targets[currentActiveIndex];
                const prevBackground = prevTarget?.querySelector(
                  "[data-background-image]",
                ) as HTMLElement;
                if (prevBackground) {
                  prevBackground.style.opacity = "0";
                }
              }

              // 現在の背景をフェードイン
              activeIndex.set(index);
              if (backgroundImage) {
                backgroundImage.style.opacity = "1";
              }
              currentActiveIndex = index;
            } else if (currentActiveIndex === index) {
              // 現在アクティブな背景が非表示になった場合のみフェードアウト
              if (backgroundImage) {
                backgroundImage.style.opacity = "0";
              }
            }
          });
        },
        {
          threshold: 0.5,
        },
      );
      observer.observe(target);
      // オブザーバーを保存（クリーンアップ用）
      (target as any).__intersectionObserver = observer;
    });

    // 初期表示：最初のセクションが表示されている場合は背景を表示
    const firstTarget = targets[0];
    if (firstTarget) {
      const firstBackground = firstTarget.querySelector(
        "[data-background-image]",
      ) as HTMLElement;
      if (firstBackground) {
        const rect = firstTarget.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
        if (isVisible) {
          firstBackground.style.opacity = "1";
          currentActiveIndex = 0;
          activeIndex.set(0);
        }
      }
    }
  }

  // 初回読み込み時
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initBackgroundAnimations);
  } else {
    initBackgroundAnimations();
  }

  // View Transitionsのページ遷移後にも実行
  // astro:page-loadはページが読み込まれた時に発火
  // astro:after-swapはページがスワップされた後に発火（フォールバック）
  document.addEventListener("astro:page-load", initBackgroundAnimations);
  document.addEventListener("astro:after-swap", initBackgroundAnimations);
</script>
