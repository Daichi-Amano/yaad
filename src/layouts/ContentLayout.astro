---
import { Image, getImage } from "astro:assets";
import Layout from "./Layout.astro";
import Copyright from "../components/Copyright.astro";
const { frontmatter } = Astro.props;
const mainImg = `../assets/${frontmatter.id}/${frontmatter.img}`;
const assets = import.meta.glob<{ default: ImageMetadata }>("../assets/**/*");

const imgAsset = await assets[mainImg]();
const optimizedImage = await getImage({ src: imgAsset.default });

// 説明文を生成（frontmatterにdescriptionがあればそれを使用、なければタイトルとカテゴリから生成）
const description =
  frontmatter.description ||
  `${frontmatter.title} - ${frontmatter.categories ? frontmatter.categories.join(", ") : frontmatter.category || ""} - YAAD.inc`;

const pageTitle = `${frontmatter.title} | YAAD.inc`;

// すべてのページデータを取得して、現在のページのインデックスを計算
const allPages = await Astro.glob("../pages/*.md");
const allContents = allPages.map(({ frontmatter }) => frontmatter);
const currentPageIndex = allContents.findIndex(
  (content) => content.id === frontmatter.id,
);
---

<Layout title={pageTitle} description={description} ogType="article">
  <main
    class="pt-[16.8rem] px-[1.8rem] relative md:pt-[16.8rem] md:px-[2.4rem]"
    data-page-index={currentPageIndex}
  >
    <div class="grid grid-cols-1 sticky top-[100px] md:grid-cols-[47.5rem_1fr]">
      <div
        class="text-white font-neue text-[4rem] font-semibold leading-[100%] mb-16 md:text-[9.6rem] md:mb-24"
      >
        <h1>{frontmatter.title}</h1>
      </div>
      <div
        class="font-neue font-normal grid grid-cols-[auto_1fr] gap-x-[5.2rem] gap-y-[1.2rem] h-fit md:row-[1/2] md:sticky md:top-[16.8rem]"
      >
        <h5 class="font-semibold">Release</h5>
        <p>{frontmatter.release}</p>
        <h5 class="font-semibold mb-8 md:mb-[7.2rem]">Category</h5>
        <p>
          {
            frontmatter.categories
              ? frontmatter.categories.join(", ")
              : frontmatter.category || ""
          }
        </p>
        <h5 class="font-semibold">Credit</h5>
        <div class="flex flex-col gap-[1.6rem] md:gap-[2.8rem]">
          {
            frontmatter.credits.map(({ name, value }: any) => {
              return (
                <div class="flex flex-col gap-[0.6rem] md:gap-[0.8rem]">
                  <p class="font-semibold">{name}</p>
                  <p>{value}</p>
                </div>
              );
            })
          }
        </div>
        <a
          class="hidden md:block text-white font-neue text-[3.2rem] font-semibold leading-[100%] underline col-span-2 my-40"
          href="/"
          data-section-index={parseInt(frontmatter.id) - 1}>Back To Page</a
        >
      </div>
      <div class="mb-[3.2rem] md:mb-0">
        <Image class="w-full h-auto" src={assets[mainImg]()} alt="main-image" />
        <div
          class="text-white text-[1.4rem] font-medium leading-[150%] tracking-[0.07rem] md:text-[2rem] [&_a]:underline [&_p]:text-white [&_p]:text-[1.4rem] [&_p]:font-medium [&_p]:leading-[150%] [&_p]:tracking-[0.07rem] md:[&_p]:text-[2rem]"
        >
          <slot />
        </div>
      </div>
    </div>
  </main>
  <footer
    class="mt-[5.6rem] text-right md:mt-56 px-[1.8rem] pb-[2.4rem] md:px-[2.4rem] md:pb-8"
  >
    <Copyright />
  </footer>
  <div
    class="fixed top-0 left-0 w-full h-full object-cover z-[-1] blur-[10px] overflow-hidden scale-110"
    style={`opacity: 1; background-image: url(${optimizedImage.src}); background-size: 120%; background-position: center;`}
  >
    <div class="absolute inset-0 bg-black/20"></div>
  </div>
  <script>
    import { activeIndex } from "../lib/store";

    // 個別ページにアクセスしたときに、activeIndexを設定してヘッダーに正しい値を表示
    document.addEventListener("DOMContentLoaded", function () {
      const mainElement = document.querySelector(
        "main[data-page-index]",
      ) as HTMLElement;
      if (mainElement) {
        const pageIndex = parseInt(
          mainElement.getAttribute("data-page-index") || "-1",
        );
        if (pageIndex >= 0) {
          activeIndex.set(pageIndex);
        }
      }

      const backToPageLink = document.querySelector(
        "a[data-section-index]",
      ) as HTMLAnchorElement;
      if (backToPageLink) {
        backToPageLink.addEventListener("click", function (e) {
          const sectionIndex = this.getAttribute("data-section-index");
          if (sectionIndex !== null) {
            sessionStorage.setItem("scrollToSection", sectionIndex);
          }
        });
      }
    });
  </script>
</Layout>
